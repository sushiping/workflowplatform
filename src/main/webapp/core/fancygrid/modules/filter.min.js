Fancy.Mixin("Fancy.store.mixin.Filter",{filterCheckItem:function(a){var b=this,c=b.filters,d=!0;for(var e in c){var f=c[e],g=a.data[e];for(var h in f){var i=f[h];switch(h){case"<":d=i>g;break;case">":d=g>i;break;case"<=":d=i>=g;break;case">=":d=g>=i;break;case"=":case"==":d=g==i;break;case"===":d=g===i;break;case"!==":d=g!==i;break;case"!=":d=g!=i;break;case"":d=new RegExp(i).test(String(g))}if(d===!1)return!1}}return!0},filterData:function(){var a=this,b=a.data,c=[],d=0,e=b.length,f=[],g=[];for(a.remoteFilter&&a.serverFilter();e>d;d++)a.order?(f.push(a.order[d]),g=b[a.order[d]]):(f.push(d),g=b[d]),a.filterCheckItem(g)&&c.push(g);a.filterOrder=f,a.filteredData=c,a.paging&&a.calcPages(),a.fire("filter")},serverFilter:function(){var a=this,b="[",c=a.filters||{};for(var d in c){var e=c[d];for(var f in e){var g=a.filterOperators[f];b+='{"operator":"'+g+'","value":"'+e[f]+'","property":"'+d+'"},'}}b=b.replace(/\,$/,""),b+="]",a.params=a.params||{},"[]"===b?(b="",delete a.params[a.filterParam]):a.params[a.filterParam]=encodeURIComponent(b),a.loadData()}}),Fancy.define("Fancy.grid.plugin.Filter",{extend:Fancy.Plugin,ptype:"grid.filter",inWidgetName:"filter",autoEnterDelay:500,constructor:function(a){var b=this;b.filters={},b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.store;b.once("render",function(){a.render()}),b.on("columnresize",a.onColumnResize,a)},render:function(){for(var a,b,c=this,d=c.widget,e=(d.body,d.leftBody,d.rightBody,d.header),f=d.leftHeader,g=d.rightHeader,h=d.columns,i=d.leftColumns,j=d.rightColumns,k=0,l=h.length;l>k;k++)a=h[k],b=e.getCell(k),a.filter&&a.filter.header?(c.renderFilter(a.type,a,b),b.addClass(d.filterHeaderCellCls)):c.header&&b.addClass(d.cellHeaderDoubleSize);for(k=0,l=i.length;l>k;k++)a=i[k],b=f.getCell(k),a.filter&&a.filter.header?(c.renderFilter(a.type,a,b),b.addClass(d.filterHeaderCellCls)):c.header&&b.addClass(d.cellHeaderDoubleSize);for(k=0,l=j.length;l>k;k++)a=j[k],b=g.getCell(k),a.filter&&a.filter.header?(c.renderFilter(a.type,a,b),b.addClass(d.filterHeaderCellCls)):c.header&&b.addClass(d.cellHeaderDoubleSize)},renderFilter:function(a,b,c){var d,e=this,f={position:"absolute",bottom:"2px"},g=b.filter;switch(a){case"string":var h=[{enter:e.onEnter,scope:e}];e.autoEnterDelay!==!1&&h.push({key:e.onKey,scope:e}),d=new Fancy.StringField({renderTo:c.dom,label:!1,style:f,events:h,emptyText:g.emptyText});break;case"number":case"grossloss":case"progressbar":case"progressdonut":var h=[{enter:e.onEnter,scope:e}];e.autoEnterDelay!==!1&&h.push({key:e.onKey,scope:e}),d=new Fancy.NumberField({renderTo:c.dom,label:!1,style:f,emptyText:g.emptyText,events:h});break;case"combo1":for(var i=[],j=0,k=b.data.length;k>j;j++){var l=b.data[j];i.push({index:l,valueText:l})}d=new Fancy.TagField({renderTo:c.dom,label:!1,style:f,displayKey:"valueText",valueKey:"index",value:"",itemCheckBox:!0,events:[{change:e.onEnter,scope:e}],data:i}),d.size({width:b.width-26,height:26});break;case"combo":var i=[],j=0,k=b.data.length;for(i.push({index:"",valueText:""});k>j;j++){var l=b.data[j];i.push({index:l,valueText:l})}d=new Fancy.Combo({renderTo:c.dom,label:!1,widthToInput:!0,style:{position:"absolute",bottom:"3px"},width:b.width-8,displayKey:"valueText",valueKey:"index",value:"",itemCheckBox:!0,height:28,emptyText:g.emptyText,events:[{change:e.onEnter,scope:e}],data:i});break;case"checkbox":d=new Fancy.Combo({renderTo:c.dom,label:!1,style:{position:"absolute",bottom:"3px"},displayKey:"valueText",valueKey:"index",width:b.width-8,height:28,widthToInput:!0,emptyText:g.emptyText,value:"",events:[{change:e.onEnter,scope:e}],data:[{index:"",valueText:""},{index:"false",valueText:"false"},{index:"true",valueText:"true"}]});break;default:var h=[{enter:e.onEnter,scope:e}];e.autoEnterDelay!==!1&&h.push({key:e.onKey,scope:e}),d=new Fancy.StringField({renderTo:c.dom,label:!1,style:f,emptyText:g.emptyText,events:h})}switch(d.filterIndex=b.index,d.column=b,d.el.on("click",function(a){a.stopPropagation()}),d.el.css("padding-left","4px"),d.el.css("padding-top","0px"),a){case"checkbox":case"combo":break;default:d.setInputSize({width:b.width-8})}},onEnter:function(a,b){var c=this,d=a.filterIndex;if(c.intervalAutoEnter&&(clearInterval(c.intervalAutoEnter),c.intervalAutoEnter=!1),delete c.intervalAutoEnter,0===b.length)return c.filters[a.filterIndex]={},void c.updateStoreFilters();var e=c.processFilterValue(b,a.column.type),f=0,g=e.length;for(c.filters[d]={};g>f;f++){var h=e[f];c.filters[d][h.operator]=h.value}c.updateStoreFilters()},processFilterValue:function(a,b){for(var c,d,e={"<":!0,">":!0,"!":!0,"=":!0},f=0,g=3,h=[],i=a.split(","),j=0,k=i.length;k>j;j++){for(f=0,c="",d=i[j];g>f;f++)e[d[f]]&&(c+=d[f]);d=d.replace(new RegExp("^"+c),""),d.length<1||("number"===b&&(d=Number(d)),h.push({operator:c,value:d}))}return h},updateStoreFilters:function(){var a=this,b=a.widget,c=b.store;c.filters=a.filters,c.changeDataView(),b.update()},onColumnResize:function(a,b){var c=this,d=(c.widget,Fancy.get(b.cell)),e=b.width,f=d.select(".fancy-field");if(0!==f.length){var g=Fancy.getWidget(f.dom.id);g.setInputSize({width:e-8})}},onKey:function(a,b,c){var d=this;d.autoEnterTime||+new Date;c.keyCode!==Fancy.key.ENTER&&(d.autoEnterTime=+new Date,d.intervalAutoEnter||(d.intervalAutoEnter=setInterval(function(){var c=new Date;d.intervalAutoEnter&&c-d.autoEnterTime>d.autoEnterDelay&&(clearInterval(d.intervalAutoEnter),delete d.intervalAutoEnter,b=a.getValue(),d.onEnter(a,b))},200)))}});