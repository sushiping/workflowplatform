Fancy.Mixin("Fancy.store.mixin.Edit",{remove:function(a){var b=this,c=(b.getTotal(),a.id||a.data.id),d=b.dataViewIndexes[a.rowIndex],e=a.rowIndex;return"server"===b.proxyType?void b.proxyCRUD("DESTROY",c):(b.data.splice(d,1),b.paging&&(e+=b.showPage*b.pageSize),b.order&&b.order.splice(e,1),b.changeOrderIndexes(d),b.paging&&(0!==b.showPage&&b.showPage*b.pageSize===b.getTotal()&&b.showPage--,b.calcPages()),b.changeDataView(),void b.fire("remove",c))},add:function(a){var b=this;b.model;return b.insert(b.getTotal(),a)},insert:function(a,b){var c=this;c.model;return c.addIndex=a,void 0===b.id&&(b.id=c.getTotal()+1),"server"!==c.proxyType?c.insertItem(b,a):(c.once("create",c.onCreate,c),void c.proxyCRUD("CREATE",b))},insertItem:function(a){var b=this,c=b.model,d=new c(a),e=b.addIndex;return delete b.addIndex,b.data.splice(e,0,d),b.order&&(b.order.splice(e,0,e),b.changeOrderIndexes(e,"+"),b.order[e]--),b.changeDataView(),b.fire("insert",d),d},onCreate:function(a,b){return this.insertItem(b)}}),Fancy.define(["Fancy.form.field.TextArea","Fancy.TextArea"],{mixins:[Fancy.form.field.Mixin],extend:Fancy.Widget,type:"field.textarea",constructor:function(){var a=this;a.Super("const",arguments)},init:function(){var a=this;a.addEvents("focus","blur","input","up","down","change","key"),a.Super("init",arguments),a.initHeight(),a.tpl=new Fancy.Template(a.tpl),a.render(),a.ons()},cls:"fancy fancy-field fancy-textarea",value:"",width:250,height:100,labelWidth:60,inputWidth:180,minHeight:100,maxHeight:210,lineHeight:12.5,emptyText:"",tpl:['<div class="fancy-field-label" style="{labelWidth}{labelDisplay}">',"{label}","</div>",'<div class="fancy-textarea-text">','<textarea autocomplete="off" placeholder="{emptyText}" type="text" class="fancy-textarea-text-input" style="{inputWidth}height:{height}px;">{value}</textarea>','<div class="fancy-field-error" style="{errorTextStyle}"></div>',"</div>",'<div class="fancy-clearfix"></div>'],ons:function(){var a=this,b=a.el.getByTag("textarea");a.input=b,b.on("blur",a.onBlur,a),b.on("focus",a.onFocus,a),b.on("input",a.onInput,a),b.on("keydown",a.onKeyDown,a),a.autoHeight&&b.on("input",a.onChange,a)},initHeight:function(){var a=this;if(a.autoHeight===!0){var b=a.value.match(/\n/g).length*a.lineHeight;b<a.minHeight?b=a.minHeight:b>a.maxHeight&&(b=a.maxHeight,setTimeout(function(){var b=a.el.getByTag("textarea");b.css({"overflow-y":"scroll"})},1)),a.height=b}},onChange:function(){var a=this,b=a.input.dom.value,c=a.el.getByTag("textarea"),d=b.match(/\n/g).length*a.lineHeight;d<a.minHeight?(d=a.minHeight,c.css({"overflow-y":"hidden"})):d>a.maxHeight?(d=a.maxHeight,c.css({"overflow-y":"scroll"})):(console.log("in 4"),c.css({"overflow-y":"hidden"})),a.height=d}}),Fancy.Mixin("Fancy.grid.mixin.Edit",{remove:function(a){this.store.remove(a)},add:function(a){this.store.add(a)},insert:function(a,b){var c=this,d=c.store;c.paging&&"server"!==d.proxyType&&(a+=d.showPage*d.pageSize),d.insert(a,b)}}),Fancy.define("Fancy.grid.plugin.Edit",{extend:Fancy.Plugin,ptype:"grid.edit",inWidgetName:"edit",clicksToEdit:2,constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this,b=a.widget,c=b.store;a.Super("init",arguments),b.once("render",function(){a.ons(),c.on("beforeupdate",a.onStoreCRUDBeforeUpdate,a),c.on("update",a.onStoreCRUDUpdate,a),c.on("beforedestroy",a.onStoreCRUDBeforeDestroy,a),c.on("destroy",a.onStoreCRUDDestroy,a)})},ons:function(){var a=this,b=a.widget,c=b.store,d="cell"+a.getClickEventName();b.on("cellclick",a.onClickCell,a),b.on(d,a.onClickCellToEdit,a),c.on("set",a.onStoreSet,a)},getClickEventName:function(){var a=this;return 1===a.clicksToEdit?"click":2===a.clicksToEdit?"dblclick":void 0},onClickCell:function(a,b){var c=this,d=c.widget,e=b.column;e.type;e.editable&&"checkbox"===e.type&&d.celledit.onCheckBoxChange(b)},onClickCellToEdit:function(a,b){var c=this,d=c.widget,e=b.column;e.type;d.celledit.hideEditor(),e.editable&&"checkbox"!==e.type&&d.celledit.edit(b)},onStoreSet:function(a,b){var c=this,d=c.widget;d.updater.updateRow(b.rowIndex)},onStoreCRUDBeforeUpdate:function(){var a=this,b=a.widget,c=a.activeCellEditParams,d=Fancy.get(c.cell);d=Fancy.get(c.cell),b.updater.updateRow(c.rowIndex),d.hasClass("fancy-grid-cell-dirty")===!1},onStoreCRUDUpdate:function(){var a=this,b=(a.widget,a.activeCellEditParams);Fancy.get(b.cell)},onStoreCRUDBeforeDestroy:function(){},onStoreCRUDDestroy:function(){var a=this,b=a.widget,c=b.store;c.loadData()}}),Fancy.define("Fancy.grid.plugin.CellEdit",{extend:Fancy.Plugin,ptype:"grid.celledit",inWidgetName:"celledit",constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.store;b.once("render",function(){a.initEditorContainer(),a.initDirtyMap(),b.on("scroll",a.onScroll,a),b.on("docclick",a.onDocClick,a),b.on("headercellmousedown",a.onHeaderCellMouseDown,a)})},onDocClick:function(a,b){var c=this,d=c.activeCellEditParams,e=c.activeEditor,f=!0;if(void 0!==e&&"combo"===d.column.type){var g=b.target;e.el.within(g)===!1&&e.list.within(g)===!1&&c.comboClick!==!0&&(f=!1),f===!1&&e.hide(),c.comboClick=!1}},initEditorContainer:function(){var a=this,b=a.widget;a.editorsContainer=b.el.select(".fancy-grid-editors")},edit:function(a){var b=this,c=b.widget,d=a.column,e=d.type;b.activeCellEditParams=a,c.edit.activeCellEditParams=a,"combo"===e?void 0===d.editor&&(d.editor=b.getComboEditor(d)):b.checkTypeEditor(e),b.hideEditor(),b.showEditor(a)},checkTypeEditor:function(a){var b=this;void 0===b[a+"Editor"]&&b.addTypeEditor(a)},addTypeEditor:function(a){var b=this,c={position:"absolute",left:"0px",top:"0px",display:"none",padding:"0px"};switch(a){case"text":b.textEditor=new Fancy.TextArea({renderTo:b.editorsContainer.dom,label:!1,style:c,events:[{enter:b.onEditorEnter,scope:b},{key:b.onKey,scope:b},{blur:b.onBlur,scope:b}]});break;case"image":b.imageEditor=new Fancy.StringField({renderTo:b.editorsContainer.dom,label:!1,style:c,events:[{enter:b.onEditorEnter,scope:b},{key:b.onKey,scope:b},{blur:b.onBlur,scope:b}]});break;case"string":b.stringEditor=new Fancy.StringField({renderTo:b.editorsContainer.dom,label:!1,style:c,events:[{enter:b.onEditorEnter,scope:b},{key:b.onKey,scope:b},{blur:b.onBlur,scope:b}]});break;case"number":b.numberEditor=new Fancy.NumberField({renderTo:b.editorsContainer.dom,label:!1,style:c,events:[{enter:b.onEditorEnter,scope:b},{key:b.onKey,scope:b},{blur:b.onBlur,scope:b}]});break;default:throw new Error("[FancyGrid error] - type "+a+" editor does not exit")}},getComboEditor:function(a){var b=this,c={position:"absolute",left:"0px",top:"0px",display:"none",padding:"0px"},d=b.widget,e=d.theme,f=b.configComboData(a.data);return"default"===e&&(e=void 0),new Fancy.Combo({theme:e,renderTo:b.editorsContainer.dom,label:!1,style:c,data:f,displayKey:"valueText",valueKey:"index",value:0,events:[{change:b.onComboChange,scope:b}]})},configComboData:function(a){for(var b=0,c=a.length,d=[];c>b;b++)d.push({index:b,valueText:a[b]});return d},showEditor:function(a){var b=this,c=(b.widget,a.column),d=c.type,e=b[d+"Editor"],f=a.cell,g=b.getCellPosition(f),h=b.getCellSize(f);"combo"===d&&(b.comboClick=!0,e=c.editor),b.activeEditor=e,b.setEditorValue(a),b.setEditorSize(h),e.show(),e.el.css(g),"combo"!==d&&e.focus()},setEditorSize:function(a){var b=this;"field.combo"===b.activeEditor.wtype?b.activeEditor.size(a):b.activeEditor.setInputSize({width:a.width,height:a.height})},hideEditor:function(){var a,b,c,d=this,e=d.widget,f=e.store,g=d.activeCellEditParams,h=d.activeEditor;h&&(c=g.column,b=h.get(),"server"===f.proxyType&&"combo"!==c.type&&(a=d.getActiveColumnKey(),b=d.prepareValue(b),f.set(g.rowIndex,a,b)),h.hide()),delete d.activeEditor},getCellPosition:function(a){var b=this,c=b.widget,d=Fancy.get(a),e=d.offset(),f=c.el.offset(),g={left:parseInt(e.left)-parseInt(f.left)-2+"px",top:parseInt(e.top)-parseInt(f.top)-2+"px"};return g},getCellSize:function(a){var b=Fancy.get(a),c=b.width(),d=b.height();return c+=2*parseInt(b.css("border-right-width")),d+=2*parseInt(b.css("border-bottom-width")),{width:c,height:d}},setEditorValue:function(a){var b=this,c=b.activeEditor;"combo"===a.column.type?c.set(c.getValueKey(a.value),!1):c.set(a.value)},onEditorEnter:function(a,b){var c=this;c.hideEditor()},onHeaderCellMouseDown:function(){var a=this;a.hideEditor()},onKey:function(a,b){var c,d=this,e=d.widget,f=e.store,g=d.activeCellEditParams;"server"!==f.proxyType&&(c=d.getActiveColumnKey(),b=d.prepareValue(b),f.set(g.rowIndex,c,b))},onScroll:function(){var a=this;a.hideEditor()},onBlur:function(){var a=this;a.hideEditor()},prepareValue:function(a){var b=this,c=b.getActiveColumnType();return"number"===c&&""!==a&&(a=Number(a)),a},getActiveColumnType:function(){var a=this,b=a.activeCellEditParams,c=b.column;return c.type},getActiveColumnKey:function(){var a=this,b=a.activeCellEditParams,c=b.column,d=c.key||c.index;return d},initDirtyMap:function(){},onCheckBoxChange:function(a){var b=this,c=b.widget,d=a.column,e=d.key||d.index,f=c.store,g=b.checkBoxChangedValue;b.activeEditor&&b.hideEditor(),void 0!==b.checkBoxChangedValue&&(delete b.checkBoxChangedValue,b.activeCellEditParams=a,c.edit.activeCellEditParams=a,f.set(a.rowIndex,e,g))},onComboChange:function(a,b){var c=this,d=c.widget,e=d.store,f=c.activeEditor,g=c.activeCellEditParams,h=c.getActiveColumnKey();b=f.getDisplayValue(b),e.set(g.rowIndex,h,b),c.hideEditor()}}),Fancy.define("Fancy.grid.plugin.RowEdit",{extend:Fancy.Plugin,ptype:"grid.rowedit",inWidgetName:"rowedit",constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.store}});